<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Krystal Client</title>
  <style>
    :root{
      --bg0:#050607; --bg1:#07090b;
      --panel:rgba(14,17,20,.72); --panel2:rgba(18,22,26,.72);
      --stroke:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --muted2:rgba(255,255,255,.45);
      --accent:#ff6fb5;
      --accent2:rgba(255,111,181,.18);
      --shadow:0 16px 50px rgba(0,0,0,.55);
      --radius:22px;
      --focus:0 0 0 3px rgba(255,111,181,.28);
      color-scheme: dark;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; overflow:hidden;
      background:
        radial-gradient(1200px 600px at 30% 10%, rgba(255,255,255,.05), transparent 60%),
        radial-gradient(800px 500px at 80% 0%, rgba(255,111,181,.06), transparent 60%),
        linear-gradient(180deg,var(--bg0),var(--bg1));
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .shell{position:relative; width:100%; height:100%; display:flex}
    .bg-molten{position:absolute; inset:0; pointer-events:none; overflow:hidden}
    .bg-molten::before,.bg-molten::after{
      content:""; position:absolute; width:860px;height:860px;border-radius:999px;
      filter:blur(38px); opacity:.55; mix-blend-mode:screen;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,120,90,.22), transparent 55%),
        radial-gradient(circle at 70% 60%, rgba(255,111,181,.18), transparent 60%),
        radial-gradient(circle at 50% 80%, rgba(180,120,255,.12), transparent 60%);
      animation:drift 14s ease-in-out infinite;
    }
    .bg-molten::before{left:-240px;top:-280px}
    .bg-molten::after{right:-260px;bottom:-320px;animation-duration:18s}
    @keyframes drift{0%{transform:translate3d(0,0,0) rotate(0)}50%{transform:translate3d(40px,26px,0) rotate(8deg)}100%{transform:translate3d(0,0,0) rotate(0)}}
    .dust{
      position:absolute; inset:-10%; pointer-events:none; opacity:.35;
      background-image:
        radial-gradient(rgba(255,255,255,.05) 1px, transparent 1px),
        radial-gradient(rgba(255,111,181,.06) 1px, transparent 1px);
      background-size:54px 54px,92px 92px;
      background-position:0 0,20px 30px;
      animation:dustmove 22s linear infinite;
    }
    @keyframes dustmove{0%{transform:translate3d(0,0,0)}100%{transform:translate3d(-60px,-45px,0)}}

    canvas#rain{position:absolute; inset:0; pointer-events:none; z-index:2;}
    canvas#rain.off{display:none}

    .left{
      position:relative; z-index:3; width:300px; padding:16px;
      border-right:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(10,12,14,.58), rgba(10,12,14,.30));
      backdrop-filter: blur(10px);
    }
    .main{position:relative; z-index:3; flex:1; min-width:0; display:flex; flex-direction:column;}
    .content{flex:1; padding:18px; overflow:auto;}

    .brand{display:flex;align-items:center;gap:10px;padding:10px 10px 14px}
    .brandDot{width:12px;height:12px;border-radius:999px;
      background:radial-gradient(circle at 30% 30%, #fff, var(--accent) 55%, rgba(0,0,0,0) 72%);
      box-shadow:0 0 0 4px rgba(255,111,181,.08);
    }
    .brandTitle{font-weight:900; letter-spacing:.4px}
    .brandSub{font-size:12px; color:var(--muted2); margin-top:2px}

    .tabBtn{
      width:100%; text-align:left; padding:14px 14px; border-radius:18px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(10,12,14,.35);
      color:var(--text);
      cursor:pointer;
      font-size:14px; font-weight:780;
      transition:transform 120ms ease, border-color 160ms ease, background 160ms ease;
    }
    .tabBtn:hover{transform:translateY(-1px)}
    .tabBtn.active{
      border-color:rgba(255,255,255,.18);
      background:radial-gradient(120% 140% at 20% 0%, var(--accent2), rgba(255,255,255,.03) 55%);
    }

    .card{
      border-radius:var(--radius);
      border:1px solid var(--stroke);
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:14px 14px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid var(--stroke);
      font-weight:900;
    }
    .cardBody{padding:14px}

    .btn{
      border-radius:16px; padding:12px 14px;
      border:1px solid var(--stroke);
      background:rgba(10,12,14,.55);
      color:var(--text);
      cursor:pointer;
      transition:transform 120ms ease, border-color 160ms ease, background 160ms ease, box-shadow 160ms ease;
      user-select:none;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .btn:focus{outline:none; box-shadow:var(--focus)}
    .btn.primary{
      border-color:rgba(255,255,255,.10);
      background:
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)),
        radial-gradient(80% 120% at 50% 0%, var(--accent2), transparent 60%);
      font-weight:900;
    }
    .btn.big{padding:14px 16px; border-radius:18px; font-weight:900;}
    .btn:active{transform:scale(.98)}
    .grid{display:grid; gap:14px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .small{font-size:12px; color:var(--muted2)}
    .muted{color:var(--muted)}
    .divider{height:1px; background:var(--stroke); margin:10px 0}

    .pill{
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(10,12,14,.35);
      font-size:12px; color:var(--muted);
    }

    .mod{
      border:1px solid var(--stroke);
      background:rgba(10,12,14,.30);
      border-radius:18px;
      padding:14px;
      display:grid;
      gap:10px;
    }
    .modTop{display:flex; gap:12px; align-items:flex-start; justify-content:space-between;}
    .modName{font-weight:950; letter-spacing:.2px}
    .modDesc{font-size:12px; color:var(--muted2); margin-top:4px}
    .metaGrid{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px}
    .metaBox{border:1px solid var(--stroke); background:rgba(10,12,14,.22); border-radius:16px; padding:10px}
    .metaLabel{font-size:11px; color:var(--muted2)}
    .metaVal{font-size:12px; color:var(--muted); margin-top:4px}
    .checks{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .check{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--stroke);
      background:rgba(10,12,14,.24);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px; color:var(--muted);
    }
    .tick{
      width:18px; height:18px; border-radius:999px;
      display:grid; place-items:center;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.12);
    }
    .tick.on{
      background:rgba(80,255,140,.16);
      border-color:rgba(80,255,140,.35);
    }

    input[type="range"]{width:100%}
    input[type="color"], input[type="text"]{
      border:1px solid var(--stroke);
      background:rgba(10,12,14,.35);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      outline:none;
    }
    input:focus{box-shadow:var(--focus)}
  </style>
</head>
<body>
  <div class="shell">
    <div class="bg-molten"></div>
    <div class="dust"></div>
    <canvas id="rain"></canvas>

    <aside class="left">
      <div class="brand">
        <div class="brandDot"></div>
        <div>
          <div class="brandTitle">Krystal Client</div>
          <div class="brandSub">Mods + Customization</div>
        </div>
      </div>

      <div class="grid" style="gap:12px; padding:6px 4px 0 4px;">
        <button class="tabBtn active" data-tab="home">Home</button>
        <button class="tabBtn" data-tab="downloads">Downloads</button>
        <button class="tabBtn" data-tab="customize">Customize</button>
        <button class="tabBtn" data-tab="discord">Discord</button>
      </div>

      <div style="position:absolute; left:16px; right:16px; bottom:16px; display:grid; gap:10px;">
        <a class="btn" href="/owner">Owner</a>
      </div>
    </aside>

    <main class="main">
      <div class="content">
        <section class="tabPage" id="tab-home">
          <div class="card">
            <div class="cardHead">
              <div>Welcome</div>
              <div class="row">
                <button class="btn big" id="btnCopyDiscord">Copy Discord</button>
                <button class="btn primary big" id="btnJoinDiscord">Join Discord</button>
              </div>
            </div>
            <div class="cardBody">
              <div class="grid" style="gap:12px;">
                <div class="small">Local time</div>
                <div class="muted" id="clock" style="font-weight:950; letter-spacing:.5px;"></div>
                <div class="small" id="date"></div>
                <div class="divider"></div>
                <div class="small" id="homeStatus"></div>
              </div>
            </div>
          </div>
        </section>

        <section class="tabPage" id="tab-downloads" style="display:none;">
          <div class="card">
            <div class="cardHead">
              <div>Downloads</div>
              <div class="row">
                <button class="btn" id="btnReloadMods">Reload</button>
                <span class="pill" id="modsCount">0 items</span>
              </div>
            </div>
            <div class="cardBody">
              <div class="divider"></div>
              <div id="modsList" class="grid" style="gap:12px;"></div>
              <div class="small" id="modsStatus"></div>
            </div>
          </div>
        </section>

        <section class="tabPage" id="tab-customize" style="display:none;">
          <div class="card">
            <div class="cardHead">
              <div>Customize</div>
              <div class="row">
                <span class="pill">Presets</span>
                <span class="pill">Rain + Noise</span>
              </div>
            </div>
            <div class="cardBody">
              <div class="grid" style="gap:14px;">
                <div>
                  <div style="font-weight:950;">Theme presets</div>
                  <div class="small">Pick a preset or make your own.</div>
                  <div class="row" id="presetRow" style="margin-top:10px;"></div>
                </div>

                <div class="divider"></div>

                <div class="grid" style="gap:10px;">
                  <div style="font-weight:950;">Create custom preset</div>
                  <div class="row">
                    <input id="customName" type="text" placeholder="Preset name (e.g. Oval Pink)" style="flex:1; min-width:220px;" />
                    <input id="customColor" type="color" value="#ff6fb5" style="width:70px; height:44px; padding:6px;" />
                    <button class="btn primary" id="btnSavePreset">Save preset</button>
                  </div>
                  <div class="small" id="presetStatus"></div>
                </div>

                <div class="divider"></div>

                <div style="font-weight:950;">Rain overlay</div>

                <div class="grid" style="gap:10px;">
                  <div class="row" style="justify-content:space-between;">
                    <div>
                      <div style="font-weight:900;">Rain</div>
                      <div class="small">Water overlay effect</div>
                    </div>
                    <button class="btn" id="btnRainToggle">On</button>
                  </div>

                  <div class="row" style="align-items:flex-end;">
                    <div style="flex:1;">
                      <div class="small">Rain speed</div>
                      <input id="rainSpeed" type="range" min="0.2" max="2.5" step="0.05" value="1" />
                    </div>
                    <span class="pill" id="rainSpeedVal">1.00×</span>
                  </div>

                  <div class="row" style="justify-content:space-between;">
                    <div>
                      <div style="font-weight:900;">Noise</div>
                      <div class="small">Soft rain sound</div>
                    </div>
                    <button class="btn" id="btnNoiseToggle">Off</button>
                  </div>

                  <div class="row" style="align-items:flex-end;">
                    <div style="flex:1;">
                      <div class="small">Noise volume</div>
                      <input id="noiseVolume" type="range" min="0" max="1" step="0.01" value="0.25" />
                    </div>
                    <span class="pill" id="noiseVolVal">25%</span>
                  </div>

                  <div class="small">Tip: browsers require a click before audio can start.</div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="tabPage" id="tab-discord" style="display:none;">
          <div class="card">
            <div class="cardHead">
              <div>Discord</div>
              <div class="row">
                <button class="btn big" id="btnCopyDiscord2">Copy Discord</button>
                <button class="btn primary big" id="btnJoinDiscord2">Join Discord</button>
              </div>
            </div>
            <div class="cardBody">
              <div class="grid" style="gap:12px;">
                <div style="font-weight:950;">Updates & support</div>
                <div class="small">Join the Discord for announcements, help, and new releases.</div>
                <div class="small" id="discordStatus"></div>
              </div>
            </div>
          </div>
        </section>

      </div>
    </main>
  </div>

<script>
  // ===== Config =====
  const LS = {
    accent: "kc.accent.v1",
    presets: "kc.custom_presets.v1",
    rainOn: "kc.rain.on.v1",
    rainSpeed: "kc.rain.speed.v1",
    noiseOn: "kc.noise.on.v1",
    noiseVol: "kc.noise.vol.v1"
  };

  const BUILTIN_PRESETS = [
    { name: "Oval Pink",     color: "#ff6fb5" },
    { name: "Molten Ice",    color: "#73c7ff" },
    { name: "Violet Storm",  color: "#a78bfa" },
    { name: "Gold Rush",     color: "#ffd26a" },
    { name: "Ocean Glass",   color: "#56f0ff" },
    { name: "Crimson Night", color: "#ff3b6b" },
    { name: "Neon Lime",     color: "#7dff8a" },
    { name: "Molten Ember",  color: "#ff7c5a" },
    { name: "Pearl Bloom",   color: "#d9b6ff" },
    { name: "Aurora Mint",   color: "#7cf7c9" }
  ];

  function pad2(n){ return String(n).padStart(2,"0"); }
  function hexToRgb(hex){
    const h = String(hex||"").replace("#","").trim();
    if (h.length !== 6) return {r:255,g:111,b:181};
    return { r:parseInt(h.slice(0,2),16), g:parseInt(h.slice(2,4),16), b:parseInt(h.slice(4,6),16) };
  }
  function rgba(hex,a){ const {r,g,b}=hexToRgb(hex); return `rgba(${r}, ${g}, ${b}, ${a})`; }
  function setAccent(hex){
    const c = hex || "#ff6fb5";
    document.documentElement.style.setProperty("--accent", c);
    document.documentElement.style.setProperty("--accent2", rgba(c, 0.18));
    document.documentElement.style.setProperty("--focus", `0 0 0 3px ${rgba(c, 0.28)}`);
    localStorage.setItem(LS.accent, c);
  }
  async function copyText(text){
    try { await navigator.clipboard.writeText(text); return true; }
    catch {
      try {
        const ta=document.createElement("textarea");
        ta.value=text; ta.style.position="fixed"; ta.style.opacity="0";
        document.body.appendChild(ta); ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        return true;
      } catch { return false; }
    }
  }

  // Tabs
  function setTab(tab){
    document.querySelectorAll(".tabBtn").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".tabPage").forEach(p=>p.style.display="none");
    const btn = document.querySelector(`.tabBtn[data-tab="${tab}"]`);
    const page = document.getElementById(`tab-${tab}`);
    if (btn) btn.classList.add("active");
    if (page) page.style.display = "";
    if (tab === "downloads") loadMods();
  }
  document.querySelectorAll(".tabBtn").forEach(btn=>{
    btn.addEventListener("click", ()=> setTab(btn.dataset.tab));
  });

  // Clock
  function tickClock(){
    const now=new Date();
    document.getElementById("clock").textContent = `${pad2(now.getHours())}:${pad2(now.getMinutes())}:${pad2(now.getSeconds())}`;
    document.getElementById("date").textContent = now.toLocaleDateString(undefined,{weekday:"long",year:"numeric",month:"long",day:"numeric"});
  }
  tickClock(); setInterval(tickClock, 1000);

  // Discord
  async function getInviteUrl(){
    // from env via API-less approach: just hardcode via Vercel env and set here if you want.
    // for now, we read from server by embedding nothing; simplest is: set DISCORD_INVITE_URL in env and paste it here if you want.
    return ""; 
  }
  const INVITE = ""; // <-- optionally hardcode your invite here (or keep blank; buttons will show a warning)

  const homeStatus = document.getElementById("homeStatus");
  const discordStatus = document.getElementById("discordStatus");

  async function doCopy(where){
    const url = INVITE || "";
    if (!url) { where.textContent = "Discord link not set yet. (Set DISCORD_INVITE_URL in Vercel and then paste here if you want.)"; return; }
    where.textContent = (await copyText(url)) ? "Copied Discord link!" : "Copy failed.";
  }
  function doJoin(where){
    const url = INVITE || "";
    if (!url) { where.textContent = "Discord link not set yet."; return; }
    window.open(url, "_blank");
  }

  document.getElementById("btnCopyDiscord").addEventListener("click", ()=>doCopy(homeStatus));
  document.getElementById("btnJoinDiscord").addEventListener("click", ()=>doJoin(homeStatus));
  document.getElementById("btnCopyDiscord2").addEventListener("click", ()=>doCopy(discordStatus));
  document.getElementById("btnJoinDiscord2").addEventListener("click", ()=>doJoin(discordStatus));

  // Presets
  function loadCustomPresets(){ try { return JSON.parse(localStorage.getItem(LS.presets)||"[]"); } catch { return []; } }
  function saveCustomPresets(arr){ localStorage.setItem(LS.presets, JSON.stringify(arr)); }
  function renderPresets(){
    const row=document.getElementById("presetRow");
    row.innerHTML="";
    const all=[...BUILTIN_PRESETS, ...loadCustomPresets()];
    for(const p of all){
      const b=document.createElement("button");
      b.className="btn";
      b.textContent=p.name;
      b.addEventListener("click", ()=>{ setAccent(p.color); document.getElementById("presetStatus").textContent=`Theme set: ${p.name}`; });
      row.appendChild(b);
    }
  }
  document.getElementById("btnSavePreset").addEventListener("click", ()=>{
    const name=document.getElementById("customName").value.trim();
    const color=document.getElementById("customColor").value;
    const status=document.getElementById("presetStatus");
    if(!name){ status.textContent="Enter a preset name."; return; }
    const existing=loadCustomPresets();
    if(existing.some(x=>x.name.toLowerCase()===name.toLowerCase())){ status.textContent="That name already exists."; return; }
    existing.push({name,color}); saveCustomPresets(existing);
    document.getElementById("customName").value="";
    status.textContent=`Saved preset: ${name}`;
    renderPresets();
  });

  // Rain overlay
  const rainCanvas=document.getElementById("rain");
  const ctx=rainCanvas.getContext("2d",{alpha:true});
  let drops=[], raf=0, lastT=0;

  const rainState={
    on:(localStorage.getItem(LS.rainOn) ?? "1")==="1",
    speed:Number(localStorage.getItem(LS.rainSpeed) || "1"),
    noiseOn:(localStorage.getItem(LS.noiseOn) ?? "0")==="1",
    noiseVol:Number(localStorage.getItem(LS.noiseVol) || "0.25")
  };

  function resizeRain(){
    const dpr=Math.max(1,Math.min(2,window.devicePixelRatio||1));
    rainCanvas.width=Math.floor(window.innerWidth*dpr);
    rainCanvas.height=Math.floor(window.innerHeight*dpr);
    rainCanvas.style.width=window.innerWidth+"px";
    rainCanvas.style.height=window.innerHeight+"px";
    ctx.setTransform(dpr,0,0,dpr,0,0);
    const count=Math.floor((window.innerWidth*window.innerHeight)/18000);
    drops=Array.from({length:Math.max(90,Math.min(380,count))},()=>makeDrop(true));
  }
  function makeDrop(randomY=false){
    const w=window.innerWidth,h=window.innerHeight;
    return { x:Math.random()*w, y: randomY?Math.random()*h:-Math.random()*200, len:10+Math.random()*22,
      vx:-20+Math.random()*40, vy:320+Math.random()*560, a:0.08+Math.random()*0.18, thick:1+Math.random()*1.5 };
  }
  function startRain(){ cancelAnimationFrame(raf); lastT=performance.now(); raf=requestAnimationFrame(tickRain); }
  function tickRain(t){
    raf=requestAnimationFrame(tickRain);
    if(!rainState.on) return;
    const dt=Math.min(0.05,(t-lastT)/1000); lastT=t;
    ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
    const accent=localStorage.getItem(LS.accent) || "#ff6fb5";
    for(const d of drops){
      d.x += d.vx*dt*rainState.speed;
      d.y += d.vy*dt*rainState.speed;
      if(d.y>window.innerHeight+40 || d.x<-40 || d.x>window.innerWidth+40) Object.assign(d, makeDrop(false));
      ctx.beginPath();
      ctx.strokeStyle=rgba(accent,d.a);
      ctx.lineWidth=d.thick;
      ctx.lineCap="round";
      ctx.moveTo(d.x,d.y);
      ctx.lineTo(d.x + d.vx*0.03, d.y + d.len);
      ctx.stroke();
    }
  }
  function setRainOn(on){
    rainState.on=!!on; localStorage.setItem(LS.rainOn, rainState.on?"1":"0");
    rainCanvas.classList.toggle("off", !rainState.on);
    document.getElementById("btnRainToggle").textContent=rainState.on?"On":"Off";
    if(rainState.on) startRain();
  }
  function setRainSpeed(v){
    rainState.speed=Math.max(0.2,Math.min(2.5,Number(v)||1));
    localStorage.setItem(LS.rainSpeed, String(rainState.speed));
    document.getElementById("rainSpeedVal").textContent=`${rainState.speed.toFixed(2)}×`;
  }

  // Noise
  let audioCtx=null, noiseNode=null, gainNode=null, filterNode=null;
  function ensureAudio(){
    if(audioCtx) return;
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    const bufferSize=2*audioCtx.sampleRate;
    const noiseBuffer=audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const out=noiseBuffer.getChannelData(0);
    for(let i=0;i<bufferSize;i++) out[i]=Math.random()*2-1;
    noiseNode=audioCtx.createBufferSource();
    noiseNode.buffer=noiseBuffer; noiseNode.loop=true;
    filterNode=audioCtx.createBiquadFilter();
    filterNode.type="lowpass"; filterNode.frequency.value=900;
    gainNode=audioCtx.createGain(); gainNode.gain.value=0;
    noiseNode.connect(filterNode); filterNode.connect(gainNode); gainNode.connect(audioCtx.destination);
    noiseNode.start(0);
  }
  function applyNoiseVol(){
    if(!rainState.noiseOn) return;
    ensureAudio();
    if(gainNode) gainNode.gain.value = rainState.noiseVol * 0.25;
  }
  function setNoiseOn(on){
    rainState.noiseOn=!!on; localStorage.setItem(LS.noiseOn, rainState.noiseOn?"1":"0");
    document.getElementById("btnNoiseToggle").textContent=rainState.noiseOn?"On":"Off";
    if(rainState.noiseOn){
      ensureAudio();
      if(audioCtx && audioCtx.state==="suspended") audioCtx.resume().catch(()=>{});
      applyNoiseVol();
    } else {
      if(gainNode) gainNode.gain.value=0;
    }
  }
  function setNoiseVol(v){
    rainState.noiseVol=Math.max(0,Math.min(1,Number(v)||0));
    localStorage.setItem(LS.noiseVol, String(rainState.noiseVol));
    document.getElementById("noiseVolVal").textContent=`${Math.round(rainState.noiseVol*100)}%`;
    applyNoiseVol();
  }

  document.getElementById("btnRainToggle").addEventListener("click", ()=>setRainOn(!rainState.on));
  document.getElementById("rainSpeed").addEventListener("input", e=>setRainSpeed(e.target.value));
  document.getElementById("btnNoiseToggle").addEventListener("click", ()=>setNoiseOn(!rainState.noiseOn));
  document.getElementById("noiseVolume").addEventListener("input", e=>setNoiseVol(e.target.value));

  // Downloads
  const modsList=document.getElementById("modsList");
  const modsStatus=document.getElementById("modsStatus");
  const modsCount=document.getElementById("modsCount");
  document.getElementById("btnReloadMods").addEventListener("click", loadMods);

  function tickPill(on){ return `<span class="tick ${on?"on":""}">${on?"✓":"•"}</span>`; }
  function esc(s){ return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c])); }

  async function loadMods(){
    modsStatus.textContent="Loading…";
    modsList.innerHTML="";
    try{
      const r=await fetch("/api/mods",{cache:"no-store"});
      const data=await r.json();
      const items=Array.isArray(data.items)?data.items:[];
      modsCount.textContent=`${items.length} items`;
      if(!items.length){ modsStatus.textContent="No mods yet."; return; }
      modsStatus.textContent="";
      for(const it of items){
        const launchers=Array.isArray(it.launchers)?it.launchers:[];
        const card=document.createElement("div");
        card.className="mod";
        card.innerHTML=`
          <div class="modTop">
            <div style="min-width:0;">
              <div class="modName">${esc(it.name)}</div>
              <div class="modDesc">${esc(it.description||"")}</div>
            </div>
            <button class="btn primary big">Download</button>
          </div>

          <div class="metaGrid">
            <div class="metaBox">
              <div class="metaLabel">Minecraft Version</div>
              <div class="metaVal">${esc(it.minecraft_version)}</div>
            </div>
            <div class="metaBox">
              <div class="metaLabel">Fabric Required</div>
              <div class="metaVal">${it.fabric_required ? "Yes" : "No"}</div>
            </div>
          </div>

          <div class="metaBox">
            <div class="metaLabel">Works on</div>
            <div class="checks">
              <span class="check">${tickPill(launchers.includes("Modrinth"))} Modrinth</span>
              <span class="check">${tickPill(launchers.includes("CurseForge"))} CurseForge</span>
              <span class="check">${tickPill(launchers.includes("Prism"))} Prism</span>
              <span class="check">${tickPill(launchers.includes("MultiMC"))} MultiMC</span>
              <span class="check">${tickPill(launchers.includes("ATLauncher"))} ATLauncher</span>
            </div>
          </div>

          <div class="small">File: <span class="muted">${esc(it.file_name)}</span></div>
        `;
        card.querySelector("button").addEventListener("click", ()=>window.open(it.file_url, "_blank"));
        modsList.appendChild(card);
      }
    } catch {
      modsStatus.textContent="Failed to load mods.";
    }
  }

  // Boot
  setAccent(localStorage.getItem(LS.accent) || "#ff6fb5");
  renderPresets();
  resizeRain();
  window.addEventListener("resize", resizeRain);

  document.getElementById("rainSpeed").value=String(rainState.speed);
  document.getElementById("noiseVolume").value=String(rainState.noiseVol);
  setRainSpeed(rainState.speed);
  setRainOn(rainState.on);
  setNoiseVol(rainState.noiseVol);
  setNoiseOn(rainState.noiseOn);

  loadMods();
</script>
</body>
</html>
